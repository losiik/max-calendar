# Max Bot

## Назначение
MAX бот автоматизирует связь с пользователем: регистрирует его в backend при первом запуске, отправляет ссылки для расшаривания календаря и позволяет принять или отклонить приглашение в один клик.

## Архитектура
Бот построен на библиотеке `maxapi`. `main.py` и `bot.py` создают Dispatcher и Bot. Команды живут в `handlers/commands`, например, `start_command.py` обрабатывает `/start` и событие `BotStarted`, вызывает `UserService` и показывает кнопки. Колбэки в `handlers/callbacks` обрабатывают кнопки расшаривания и подтверждения слотов. Сервисы (`services/*`) инкапсулируют запросы к backend: `ServerService` шлёт HTTP вызовы, `ShareService` получает ссылку `bot_url?startapp=<token>`, `TimeSlotService` подтверждает встречи. Зависимости резолвятся через `dependes.py`, чтобы можно было подменять сервисы в тестах. Любая бизнес-логика вынесена в сервисы, а хендлеры остаются тонкими.

## Переменные окружения
MAX_API_KEY - токен MAX платформы для бота.  
BACKEND_URL - адрес FastAPI (например `https://max.expalingpt.ru`).  
BOT_URL - публичная ссылка на WebApp, которая используется в кнопке "Поделиться календарем".

Все переменные можно хранить в `max_bot/.env`, файл подхватывается при запуске контейнера и в локальном режиме.

## Локальный запуск
1. Создайте `.env` с переменными из раздела выше.  
2. Установите зависимости: `pip install -r max_bot/requirements.txt`.  
3. Запустите `python -m max_bot.main` (при необходимости через `PYTHONPATH=.`). Dispatcher подключится к MAX API и начнёт получать апдейты.  
4. При изменениях в хендлерах перезапустите процесс.

## Docker
`max_bot/Dockerfile` использует python:3.12, копирует репозиторий, устанавливает зависимости из `max_bot/requirements.txt` и задаёт `PYTHONPATH=/bot`. В docker-compose бот стартует командой `python -u max_bot/main.py` после небольшой задержки, чтобы backend успел подняться. Для продакшена добавьте healthcheck или систему перезапуска Supervisor.

## Интеграция с backend
Бот использует HTTP-клиент `aiohttp` и вызывает `api/v1/users/`, `api/v1/share/{max_id}`, `api/v1/time_slots/`. Все URL собираются на основе `BACKEND_URL`, поэтому важно указывать адрес с завершающим `/`. Бот не хранит состояние БД - вся бизнес-логика живёт на сервере.
