# Frontend

## Назначение

SPA на React и TypeScript для MAX WebApp. В приложении юзер видит личные слоты, настройки рабочего времени, а также гостевой календарь, который открывается по `startapp` параметру из бота. При первом запуске юзеру предлагается пройти онбординг по использованию приложения. У юзера есть ответ вибрацией на касания. 

## Технологии и архитектура

Vite отвечает за сборку. Tailwind и Max UI покрывают стили. TanStack Query инкапсулирует запросы к REST API, Zustand хранит состояние фич (дни, гостевой режим, модалки). При разработке был использован feature sliced design подход. `entities` описывают доменные модели, `features` содержат сценарии (управление доступностью, бронирование, настройки), `widgets` представляют сложные компоненты, `pages` собирают экран, `providers` включают роутер и React Query, `shared` содержит утилиты, дизайн токены и интеграцию с MAX WebApp.

### package.json
Основные зависимости перечислены в `package.json` с закрепленными версиями:
- `react`, `react-dom`, `react-router-dom` - ядро UI и роутинг.
- `@maxhub/max-ui`, `tailwindcss`, `postcss`, `autoprefixer` - компоненты и стили.
- `@tanstack/react-query`, `axios`, `zustand` - сетевые запросы и состояние.
- `typescript`, `vite`, `@vitejs/plugin-react` - сборка и типизация.
- `eslint`, `@typescript-eslint/*` - проверка качества кода.
Скрипты `dev`, `build`, `preview`, `deploy`, `lint` описаны в разделе `scripts`, что позволяет воспроизводимо собирать и деплоить фронтенд.

## Переменные окружения
VITE_API_BASE_URL - базовый адрес бекенда (например `https://max.expalingpt.ru/api/v1`).  
VITE_MAX_USER_ID - необязательная переменная, чтобы подменять пользователя при запуске вне Max.
VITE_USE_MOCKS - необязательная переменная, чтобы использовать моки вместо реальных запросов (если true - используется VITE_MAX_USER_ID).

## Локальный запуск
1. Перейти в папку `frontend` и установить зависимости `npm i`.
2. Создать `.env.development` с переменными из раздела выше.
3. Выполнить `npm run dev` и проксировать порт (по умолчанию 5173) в окружение Max WebApp или открыть в браузере с тестовой переменной `VITE_MAX_USER_ID`.

ВАЖНО! URL-параметры никак не обрабатываются. В MAXе одновременно с появлением в объекте `window.WebApp` к ссылке на сайт добавляются URL-параметры, но в проекте не предусмотрена их обработка. Только через глобальный объект `window`.

## Сборка и деплой
`npm run build` собирает статику в `dist`. Статический контент можно отдавать с любого CDN или GitHub Pages. Для GitHub Pages предусмотрен скрипт `npm run deploy`, который копирует `index.html` в `404.html`, пушит содержимое `dist` в специальный отдельный репозиторий и ветку `gh-pages`. При продакшн-деплое нужно в хостинге настроить переменную `VITE_API_BASE_URL`, чтобы фронт ходил к продовому бекенду. Результат доступен по адресу домена, указанного в настройках Pages ([https://aeroserg.github.io/max-calendar](https://aeroserg.github.io/max-calendar)).

## API и интеграции

Регистрация пользователя вызывается при монтировании приложения (`ensureUserRegistered`). Гостевые календари открываются только, если от Max пришел `start_param` в глобальном объекте. Любая клиентская операция (создать слот, удалить, сохранить настройки) обращается к REST ручкам `/api/v1/*`, которые описаны в backend README.

Работа внутри приложения строится на max Bridge:
- `window.WebApp.initData` используется для авторизации. При первом открытии вкладки фронт отправляет строку `init_data` в `PUT /users/`, получает токен и хранит его в `localStorage` 2 часа. Токен автоматически обновляется заранее и подставляется в `Authorization: Bearer …` через axios-интерцептор.
- `getStartAppPayload` считывает `start_param`, чтобы открыть чужой календарь, если пользователь пришёл по ссылке из бота.
- Также использованы `enableClosingConfirmation`, нативная `enableBackButton` кнопка, различные виды haptics.

Если `init_data` временно недоступно (например, WebApp ещё не готов), фронт пробует снова при следующем запросе, чтобы всегда получить свежий токен и сообщить бэкенду о новом визите.

## Структура исходников
`src/app` содержит точку входа и глобальные стили. `src/providers` включает Router и QueryClient. `src/entities` инкапсулируют типы календаря и API функцию `entities/event/api`. `src/features` отвечают за прикладную бизнес-логику и сторы Zustand. `src/widgets` - готовые компоненты, в частности, календарь. `src/pages` собирают layout, `src/shared` хранит модалки, утилиты времени, интеграцию с Max.

## Проверка качества
`npm run lint` запускает линтер.
